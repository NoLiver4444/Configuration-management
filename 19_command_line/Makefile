# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
CXX = g++
CXXFLAGS = -Wall -Wextra -std=c++17 -pedantic-errors
LDFLAGS = 

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
SRC_DIR = src
CORE_DIR = $(SRC_DIR)/core
UTILS_DIR = $(SRC_DIR)/utils
OBJ_DIR = obj
BIN_DIR = bin
INCLUDE_DIR = include
CONFIG_DIR = config
SCRIPTS_DIR = scripts
TEST_VFS_DIR = test_vfs
TESTS_DIR = tests

# –¶–µ–ª–∏
TARGET = terminal

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
SRCS = $(SRC_DIR)/main.cpp \
       $(CORE_DIR)/commandline.cpp \
       $(CORE_DIR)/config.cpp \
       $(CORE_DIR)/vfs_manager.cpp \
       $(CORE_DIR)/vfs_node.cpp \
       $(UTILS_DIR)/console.cpp

OBJS = $(SRCS:$(SRC_DIR)/%.cpp=$(OBJ_DIR)/%.o)

# –§–ª–∞–≥–∏ include
INCLUDE_FLAGS = -I$(INCLUDE_DIR) -I$(SRC_DIR)/core -I$(SRC_DIR)/utils

.PHONY: all clean rebuild run test test-vfs help init tree

# –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
all: $(BIN_DIR)/$(TARGET)

# –°–±–æ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
$(BIN_DIR)/$(TARGET): $(OBJS) | $(BIN_DIR)
	$(CXX) $(CXXFLAGS) $(OBJS) -o $@ $(LDFLAGS)
	@echo "\n\033[0;32m‚úÖ Terminal compiled successfully!\033[0m"
	@echo "üöÄ Run with: ./$(BIN_DIR)/$(TARGET)"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) $(INCLUDE_FLAGS) -c $< -o $@

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
$(OBJ_DIR):
	mkdir -p $(OBJ_DIR) $(OBJ_DIR)/core $(OBJ_DIR)/utils

$(BIN_DIR):
	mkdir -p $(BIN_DIR)

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
run: all
	@echo "\n\033[0;32müéØ Running terminal...\033[0m\n"
	./$(BIN_DIR)/$(TARGET)

# –¢–µ—Å—Ç —Å VFS
test-vfs: all
	@echo "\n\033[0;32müß™ Testing with VFS...\033[0m\n"
	./$(BIN_DIR)/$(TARGET) --vfs-path $(TEST_VFS_DIR) --script $(SCRIPTS_DIR)/test_vfs.txt

# –¢–µ—Å—Ç —Å –∫–æ–Ω—Ñ–∏–≥–æ–º
test-config: all
	@echo "\n\033[0;32müìã Testing with config...\033[0m\n"
	./$(BIN_DIR)/$(TARGET) --config $(CONFIG_DIR)/config.toml

# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é VFS —Å—Ç—Ä—É–∫—Ç—É—Ä—É
create-test-vfs:
	@echo "\n\033[0;32müìÅ Creating test VFS structure...\033[0m"
	mkdir -p $(TEST_VFS_DIR)/folder1
	mkdir -p $(TEST_VFS_DIR)/folder2/subfolder
	mkdir -p $(TEST_VFS_DIR)/folder3/level2/level3
	
	echo "Hello from file1.txt" > $(TEST_VFS_DIR)/file1.txt
	echo "Content of file2" > $(TEST_VFS_DIR)/folder1/file2.txt
	echo "Nested file content" > $(TEST_VFS_DIR)/folder2/subfolder/file3.txt
	echo "Deep file content" > $(TEST_VFS_DIR)/folder3/level2/level3/deep_file.txt
	echo "Another file" > $(TEST_VFS_DIR)/folder2/file4.txt
	echo "Level 2 file" > $(TEST_VFS_DIR)/folder3/level2/file5.txt
	echo "Root file" > $(TEST_VFS_DIR)/folder3/file6.txt
	@echo "\033[0;32m‚úÖ Test VFS structure created!\033[0m"

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
tree:
	@echo "\n\033[0;36müìÅ Project structure:\033[0m"
	@tree -I 'bin|obj|*.o' -d

# –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
init:
	mkdir -p $(SRC_DIR)/core $(SRC_DIR)/utils $(OBJ_DIR) $(BIN_DIR) $(INCLUDE_DIR)/terminal \
	         $(CONFIG_DIR) $(SCRIPTS_DIR) $(TEST_VFS_DIR) $(TESTS_DIR) docs
	@echo "\n\033[0;32müìÅ Project structure created!\033[0m"

# –û—á–∏—Å—Ç–∫–∞
clean:
	rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo "\n\033[0;32müßπ Clean completed!\033[0m"

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
distclean: clean
	rm -f *.log *.tmp
	@echo "\n\033[0;32müßπ Deep clean completed!\033[0m"

# –¢–µ—Å—Ç–æ–≤—ã–µ —Ü–µ–ª–∏
test-basic: all
	@echo "\n\033[0;32müß™ Running basic test...\033[0m\n"
	./$(BIN_DIR)/$(TARGET) --config $(CONFIG_DIR)/basic_test.toml

test-full: all
	@echo "\n\033[0;32müß™ Running full test...\033[0m\n"
	./$(BIN_DIR)/$(TARGET) --config $(CONFIG_DIR)/full_test.toml

test-error: all
	@echo "\n\033[0;32müß™ Running error test...\033[0m\n"
	./$(BIN_DIR)/$(TARGET) --config $(CONFIG_DIR)/error_test.toml

test-all: test-basic test-full test-error

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞
rebuild: clean all

# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏
create-test-configs:
	@echo "\n\033[0;32müìù Creating test configs...\033[0m"
	mkdir -p $(CONFIG_DIR)
	echo 'vfs_path = "test_vfs"' > $(CONFIG_DIR)/basic_test.toml
	echo 'script_path = "scripts/basic_test.txt"' >> $(CONFIG_DIR)/basic_test.toml
	echo 'vfs_path = "test_vfs"' > $(CONFIG_DIR)/full_test.toml
	echo 'script_path = "scripts/test_vfs.txt"' >> $(CONFIG_DIR)/full_test.toml
	echo 'vfs_path = "test_vfs"' > $(CONFIG_DIR)/error_test.toml
	echo 'script_path = "scripts/error_test.txt"' >> $(CONFIG_DIR)/error_test.toml
	@echo "\033[0;32m‚úÖ Test configs created!\033[0m"